<div class="container">
  <h3 class="text-center mt-5 mb-4">Détails de l'annonce</h3>
  <% if policy(@annonce).show? %>
    <!-- Carousel -->
    <div id="carouselExampleIndicators" class="carousel slide" data-ride="carousel">
      <ol class="carousel-indicators">
        <li data-target="#carouselExampleIndicators" data-slide-to="0" class="active"></li>
        <li data-target="#carouselExampleIndicators" data-slide-to="1"></li>
        <li data-target="#carouselExampleIndicators" data-slide-to="2"></li>
      </ol>
      <div class="carousel-inner">
        <div class="carousel-item active text-center" style="background-color: rgb(200, 200, 200)">
          <%= cl_image_tag @annonce.photo, class: "rounded-top picture-carousel", style: "height:80vh; object-position: center center; object-fit: cover"%>
        </div>
        <div class="carousel-item text-center" style="background-color: rgb(200, 200, 200)">
          <%= cl_image_tag @annonce.photo1, class: "rounded-top picture-carousel", style: "height:80vh; object-position: center center; object-fit: cover"%>
        </div>
        <div class="carousel-item text-center" style="background-color: rgb(200, 200, 200)">
          <%= cl_image_tag @annonce.photo2, class: "rounded-top picture-carousel", style: "height:80vh; object-position: center center; object-fit: cover"%>
        </div>
        <!-- <div class="carousel-item">
          <img src="..." class="d-block w-100" alt="...">
        </div> -->
      </div>
      <a class="carousel-control-prev" href="#carouselExampleIndicators" role="button" data-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="sr-only">Previous</span>
      </a>
      <a class="carousel-control-next" href="#carouselExampleIndicators" role="button" data-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="sr-only">Next</span>
      </a>
    </div>
    <div class=" p-3", style="box-shadow: 0 0 5px rgba(0,0,0,0.1)">
      <!-- si le current_user a publié l'annonce -->
      <% if current_user == @annonce.user %>
        <h4 class="mr-3 mt-3 mb-0", style=""><%= @annonce.titre_annonce %> - <%= @annonce.loyer_mensuel %> euros / mois</h4>
        <%= link_to "modifier", edit_annonce_path(@annonce) %> /
        <%= link_to "supprimer", annonce_path(@annonce), method: :delete%>
        <p class="mt-4">Description : <%= @annonce.description %></p>
        <div class="row">
          <div class="col-sm-12 col-md-6 col-lg-6">
            <p>Type de bien : <%= @annonce.type_de_bien %></p>
            <p>Nombre de pièces : <%= @annonce.pièces %> </p>
            <p>Surface : <%= @annonce.surface %>  m2</p>
            <p>Meublé : <%= @annonce.meublé == "Meublé" ? "Oui" : 'Non' %></p>
          </div>
          <div class="col-sm-12 col-md-6 col-lg-6">
            <p>GES : <%= @annonce.ges %></p>
            <p>Classe énergie : <%= @annonce.classe_énergie %></p>
            <p><i class="fas fa-map-marker-alt mr-3"></i> <%= @annonce.adresse %></p>
            <p><i class="fas fa-city mr-3"></i> <%= @annonce.ville %></p>
          </div>
          <div class="mt-3 p-2 col-sm-12 col-md-8 offset-md-2 text-center " style=" border-radius: 30px">
            <!-- if agent is assigned to the flat show agent info -->
            <% unless @annonce.agent_user_id.nil? %>
              <p style="font-weight: bold; color: #D8A727">Agent Realbeez en charge du dossier</p>
              <p style="font-weight: bold"><%= @agent.prénom.titlecase %></p>
              <p><i class="fas fa-envelope mr-3 mr-3"></i> <%= @agent.email %></p>
              <p class="m-0"><i class="fas fa-phone-square mr-3"></i> <%= @agent.téléphone %></p>
            <% else %>
              <!-- if no agent show proprio info  -->
              <p><i class="fas fa-envelope mr-3 mr-3"></i> <%= @annonce.email %></p>
              <p class="m-0"><i class="fas fa-phone-square mr-3"></i> <%= @annonce.téléphone %></p>
            <% end %>
          </div>
        </div>
        <!-- Le current_user n'a pas publié l'annonce  -->
      <% else %>
        <h4 class="mr-3 mt-3 mb-0", style=""><%= @annonce.titre_annonce %> - <%= @annonce.loyer_mensuel %> euros / mois</h4>
        <p class="mt-4">Description : <%= @annonce.description %></p>
        <div class="row">
          <div class="col-sm-12 col-md-6 col-lg-6">
            <p>Type de bien : <%= @annonce.type_de_bien %></p>
            <p>Nombre de pièces : <%= @annonce.pièces %> </p>
            <p>Surface : <%= @annonce.surface %>  m2</p>
            <p>Meublé : <%= @annonce.meublé == "Meublé" ? "Oui" : 'Non' %></p>
          </div>
          <div class="col-sm-12 col-md-6 col-lg-6">
            <p>GES : <%= @annonce.ges %></p>
            <p>Classe énergie : <%= @annonce.classe_énergie %></p>
            <p><i class="fas fa-city mr-3"></i> <%= @annonce.ville %></p>
          </div>
        </div>
        <div class="mt-3 p-2 col-sm-12 col-md-8 offset-md-2 text-center" style="; border-radius: 30px">
          <!-- if agent is assigned to the flat show agent info -->
          <% unless @annonce.agent_user_id.nil? %>
            <p style="font-weight: bold; color: #D8A727">Agent Realbeez en charge du dossier</p>
            <p style="font-weight: bold"><%= @agent.prénom.titlecase %></p>
            <p><i class="fas fa-envelope mr-3 mr-3"></i> <%= @agent.email %></p>
            <p class="m-0"><i class="fas fa-phone-square mr-3"></i> <%= @agent.téléphone %></p>
          <% else %>
            <!-- if no agent show proprio info  -->
            <p><i class="fas fa-envelope mr-3 mr-3"></i> <%= @annonce.email %></p>
            <p class="m-0"><i class="fas fa-phone-square mr-3"></i> <%= @annonce.téléphone %></p>
          <% end %>
        </div>
      <% end %>
    </div>
    <div class="mt-4 mb-2">
      <% if user_signed_in?  %>
        <!-- if no agent is managing the flat -->
        <% if @annonce.agent_user_id.nil? && current_user.statut == "Agent" && @annonce.user != current_user %>
          <!-- Check if agent already applied -->
          <% if @annonce.candidatures.any? { |c| c.user_id = current_user.id} %>
            <p class="mt-2 pb-0 text-center"><%= link_to "Candidature en cours", candidature_agent_path, style:"font-weight: bold; color: green"  %></p>
          <% else %>
            <div class="text-center my-2" >
              <%= link_to "Gérer ce bien", new_annonce_candidature_path(@annonce), class: "btn btn-primary", style:"font-size: 14px" %>
            </div>
          <% end %>
          <!-- if agent assigned and the agent is the current user -->
        <% elsif @annonce.agent_user_id != nil && @annonce.agent_user_id == current_user.id.to_s %>
          <!-- Coordonnées du propriétaire visible que pour l'agent -->
          <div class="row p-2 mt-5">
            <div class="col-12 col-md-8">
              <p style="font-weight: bold">Récuperer les clés du bien à louer auprès du propriétaire ci-dessous :</p>
              <p>Propriétaire : <%= @annonce.user.prénom.capitalize %> <%= @annonce.user.nom.capitalize %></p>
              <p>Adresse du bien à louer : <%= @annonce.adresse %></p>
              <p><i class="fas fa-envelope mr-3 mr-3"></i> <%= @annonce.user.email %></p>
              <p><i class="fas fa-phone-square mr-3"></i> <%= @annonce.user.téléphone %></p>
            </div>
            <!-- when flat is rented need to checkout -->
            <div class="col-12 col-md-4 border d-flex align-items-center justify-content-around p-2" style="border-radius: 30px; ; box-shadow: 1px 1px 5px rgba(0,0,0,0.2);">
              <div class="">
                <% if @annonce.checkout_agent != "check" %>
                  <div class="text-center" style="">
                    <p style="font-weight: bold; color: #D8A727">Valider lorsque ce bien est loué</p>
                    <p><%= link_to "Valider", checkout_agent_path(@annonce), class: "btn btn-success" %></p>
                  </div>
                <% else %>
                  <!-- flat is rented and checked out by proprio -->
                  <div class="text-center" style="font-size:; font-weight: bold">
                    Validation agent
                    <% if @annonce.checkout_agent == "check" %>
                      <i class="fas fa-check" style="color: green"></i>
                    <% else %>
                      <i class="fas fa-times" style="color: red"></i>
                    <% end %>
                  </div>
                  <div class="text-center" style="font-size:; font-weight: bold">
                    Validation propriétaire
                    <% if @annonce.checkout_proprio == "check" %>
                      <i class="fas fa-check" style="color: green"></i>
                    <% else %>
                      <i class="fas fa-times" style="color: red"></i>
                    <% end %>
                  </div>
                <% end %>
                <div class="mt-2">
                  <% if @annonce.statut == "Loué"%>
                    <% @annonce.orders.each do |order| %>
                      <% if order.state == "paid" %>
                        <p class="mb-1"><strong>Ordre de paiement n°<%= order.id %> : Reçu</strong><i class="fas fa-check ml-1" style="color: green"></i></p>
                      <% else %>
                        <p class="mb-1"><strong>Ordre de paiement n° <%= order.id %> : En attente</strong><i class="fas fa-times ml-1" style="color: red"></i></p>
                      <% end %>
                    <% end %>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
          <!-- agent is assigned and the flat owner is the current user -->
        <% elsif @annonce.agent_user_id != nil && @annonce.user_id == current_user.id %>
          <!-- when flat is rented need to checkout -->
          <% if @annonce.checkout_proprio != "check" %>
            <div class="text-center mt-5" style="">
              <p style="font-weight: bold; color: #D8A727">Confirmer lorsque <%= @agent.prénom.titlecase %> aura loué ce bien</p>
              <%= form_tag orders_path do %>
                <%= hidden_field_tag 'annonce_id', @annonce.id %>
                <%= submit_tag 'Confirmer et payer', class: 'btn btn-primary' %>
              <% end %>
            </div>
          <% else %>
            <!-- flat is rented and checked out by proprio -->
            <div class="text-center" style="font-size:; font-weight: bold">
              Validation agent
              <% if @annonce.checkout_agent == "check" %>
                <i class="fas fa-check" style="color: green"></i>
              <% else %>
                <i class="fas fa-times" style="color: red"></i>
              <% end %>
            </div>
            <div class="text-center" style="font-size:; font-weight: bold">
              Validation propriétaire
              <% if @annonce.checkout_proprio == "check" %>
                <i class="fas fa-check" style="color: green"></i>
              <% else %>
                <i class="fas fa-times" style="color: red"></i>
              <% end %>
            </div>
          <% end %>
          <div class="mt-2 text-center">
            <% if @annonce.statut == "Loué"%>
              <% @annonce.orders.each do |order| %>
                <% if order.state == "paid" %>
                  <p class="mb-1"><strong>Ordre de paiement n°<%= order.id %> : Reçu</strong><i class="fas fa-check ml-1" style="color: green"></i></p>
                <% else %>
                  <p class="mb-1"><strong>Ordre de paiement n° <%= order.id %> : En attente</strong><i class="fas fa-times ml-1" style="color: red"></i></p>
                <% end %>
              <% end %>
            <% end %>
          </div>
        <% end %>
      <% end %>
      <%#= link_to "Louer ce bien", "", class: "btn btn-success"  %>
    </div>
    <!-- link to previous page -->
    <!--  <div class="mb-4"><%#= link_to 'Retour', 'javascript:history.go(-1);' %></div> -->
  <% end %>
</div>
<% if @annonce.latitude != nil %>
  <div class="container my-5">
    <div
      id="map"
      style="width: 100%;
      height: 600px;"
      data-markers="<%= @markers.to_json %>"
      data-mapbox-api-key="<%= ENV['MAPBOX_API_KEY'] %>"
    ></div>
  <% end %>
  <div class="container my-3 pl-0">
    <%= link_to "Toutes les annonces", annonces_path, style:"font-size: 16px" %>
  </div>
</div>
<!-- code to show all the picture uploaded by multiple upload -->
<!-- <ul>
  <%# @annonce.pictures.each do |picture| %> -->
<!-- `picture` here is an instance of the Picture model -->
<!--   <li><%#= cl_image_tag(picture.photo, width: 400, height: 300, crop: :fill) %></li>
  <%# end %>
</ul> -->