<div class="container mb-5">
  <!-- show annonces of current user -->
  <% if params[:action] == "mes_annonces" %>
    <%= render 'shared/mes_annonces' %>
    <!-- show flats managed by current user -->
  <% elsif params[:action] == "biens_a_gerer" %>
    <%= render 'shared/biens_a_gerer' %>
  <% else %>
    <!-- show all annonces -->
    <h3 class="text-center mt-5 mb-4">Annonces de biens à louer</h3>
    <!-- search bar looking for address nearby 20 km -->
    <nav class="navbar navbar-light justify-content-around">
      <%= form_for :search, defaults: { required: false }, url:annonces_path, method: "GET", html: { class: '' } do |f| %>
        <section style="position: relative; text-align:center;">
          <%= f.text_field :query, label: false, placeholder: "Entrer votre adresse", input_html: {}, style: "width: 20em; border-radius: 9999px; border-style: none; height: 2.5em; margin-left: auto; margin-right: auto; left: 0; right: 0; padding-left: 16px; opacity: 0.8;" %>
        </section>
        <section style=" text-align:center;">
          <%= f.submit "Let's go!", class: "btn-yellow-mustard-big my-3" %>
        </section>
      <% end %>
    </nav>
    <div class="border-top mt-3 mb-5 pt-2 d-flex justify-content-between">
      <% if @annonces.nil? %>
        <p class="" style="color: rgb(150, 150, 150);"><em>Nombre de biens trouvés (<%= @annonces_no_result.count %>)</em></p>
      <% else %>
        <p class="" style="color: rgb(150, 150, 150);"><em>Nombre de biens trouvés (<%= @annonces.count %>)</em></p>
      <% end %>
      <!-- ==========search by name ======= -->
      <%= form_for :search_all, defaults: { required: false }, url:annonces_path, method: "GET", html: { class: '' } do |f| %>
        <section style="position: relative; text-align:center;">
          <%= f.text_field :query, label: false, placeholder: "Rechercher", input_html: {}, style: "width: 8em; border-radius: 5px; border-style: none; height: 2.5em; margin-left: auto; margin-right: auto; left: 0; right: 0; padding-left: 16px; opacity: 0.8; " %>
        </section>
      <% end %>
      <!-- =================================== -->
    </div>
    <div id="" class="row mt-4">
      <% if @annonces != []  %>
        <% @annonces.each do |annonce| %>
          <div class="col-sm-12 col-md-6 col-lg-4">
            <div class="content border mb-5", style="box-shadow: 0 0 5px rgba(0,0,0,0.1); background-color: white">
              <%= cl_image_tag annonce.photo, class: "rounded-top", style: "height:200px; object-position: center center; object-fit: cover; width: 100%"%>
              <div class="px-3">
                <div class="mt-2">
                  <p class=""class="text-left mb-2", style="font-size: 14px"><i class="fas fa-map-marker-alt"></i> <%= annonce.ville %></p>
                  <p class="text-left text-truncate mt-0", style="font-size: 20px"><%= annonce.titre_annonce %></p>
                </div>
                <div class="mt-0">
                  <p class='my-1', style="font-size: 14px">Nb de pièces: <%= annonce.pièces %></p>
                  <p style="font-size: 14px">Loyer mensuel: <%= annonce.loyer_mensuel %> €</p>
                  <div class="d-flex px-0 justify-content-around">
                    <!-- if agent is assigned to the flat show agent info -->
                    <% unless annonce.agent_user_id.nil? %>
                      <p style="color:rgba(0,0,0,0.6)"><i class="fas fa-phone"></i> <%= User.find(annonce.agent_user_id).téléphone%></p>
                    <% else %>
                      <p style="color:rgba(0,0,0,0.6)"><i class="fas fa-phone"></i> <%= annonce.téléphone%></p>
                    <% end %>
                    <%= link_to "Details", annonce_path(annonce), class: "my-0", style:"font-size: 14px; text-decoration: underline" %>
                    <div class="">
                      <%= link_to "", new_conversation_path(message: {to: annonce.user.id }), class: "fas fa-envelope", style:"font-size: 20px; color: #D8A727" %>
                    </div>
                  </div>
                </div>
              </div>
              <!-- all links with gérer et valider -->
              <% if user_signed_in?  %>
                <!-- if no agent is managing the flat -->
                <% if annonce.agent_user_id.nil? && current_user.statut == "Agent" && annonce.user != current_user %>
                  <!-- Check if agent already applied -->
                  <% if annonce.candidatures.any? { |c| c.user_id = current_user.id} %>
                    <p class="mt-2 pb-0 text-center"><%= link_to "Déja postulé", candidature_agent_path, style:"font-weight: bold; color: green"  %></p>
                    <!--  <p class="mt-2 pb-0 text-center" style="font-weight: bold; color: green">Déja postulé</p> -->
                  <% else %>
                    <div class="text-center my-2" >
                      <%= link_to "Gérer ce bien", new_annonce_candidature_path(annonce), class: "btn btn-transparent", style:"font-size: 14px" %>
                    </div>
                  <% end %>
                  <!-- if agent assigned and the agent is the current user -->
                <% elsif annonce.agent_user_id != nil && annonce.agent_user_id == current_user.id.to_s %>
                  <!-- when flat is rented need to checkout -->
                  <% if annonce.checkout_agent != "check" %>
                    <div class="text-center my-2 " style="">
                      <!-- <p style="font-weight: bold; color: #D8A727">Valider lorsque ce bien est loué</p> -->
                      <%= link_to "Vous avez loué ce bien!", checkout_agent_path(annonce), class: "btn btn-transparent-bold", style:"font-size: 14px",data: { confirm: 'Vous confirmer que ce bien a été loué.' } %>
                    </div>
                  <% else %>
                    <!-- flat is rented and checked out by proprio -->
                    <div class="text-center mt-2" style="font-size: 12px; font-weight: bold">
                      Validation agent
                      <% if annonce.checkout_agent == "check" %>
                        <i class="fas fa-check" style="color: green"></i>
                      <% else %>
                        <i class="fas fa-times" style="color: red"></i>
                      <% end %>
                    </div>
                    <div class="text-center mb-2" style="font-size: 12px; font-weight: bold">
                      Validation propriétaire
                      <% if annonce.checkout_proprio == "check" %>
                        <i class="fas fa-check" style="color: green"></i>
                      <% else %>
                        <i class="fas fa-times" style="color: red"></i>
                      <% end %>
                    </div>
                  <% end %>
                  <!-- agent is assigned and the flat owner is the current user -->
                <% elsif annonce.agent_user_id != nil && annonce.user_id == current_user.id %>
                  <!-- when flat is rented need to checkout -->
                  <% if annonce.checkout_proprio != "check" %>
                    <div class="text-center my-2" style="">
                      <%= form_tag orders_path do %>
                        <%= hidden_field_tag 'annonce_id', annonce.id %>
                        <%= submit_tag 'J\'ai loué mon bien!', data: { confirm: 'Vous confirmez que votre bien a été loué. Vous allez être redirigé vers le site de paiement sécurisé.' }, class: 'btn btn-transparent-bold', style:'font-size: 14px' %>
                      <% end %>
                    </div>
                  <% else %>
                    <!-- flat is rented and checked out by proprio -->
                    <div class="text-center mt-2" style="font-size: 12px; font-weight: bold">
                      Validation agent
                      <% if annonce.checkout_agent == "check" %>
                        <i class="fas fa-check" style="color: green"></i>
                      <% else %>
                        <i class="fas fa-times" style="color: red"></i>
                      <% end %>
                    </div>
                    <div class="text-center mb-2" style="font-size: 12px; font-weight: bold">
                      Validation propriétaire
                      <% if annonce.checkout_proprio == "check" %>
                        <i class="fas fa-check" style="color: green"></i>
                      <% else %>
                        <i class="fas fa-times" style="color: red"></i>
                      <% end %>
                    </div>
                  <% end %>
                <% else %>
                  <p class="" style="color: white; font-size: 21px">hello</p>
                <% end %>
              <% end %>
            </div>
          </div>
        <% end %>
        <!-- Mapbox -->
        <div class="container">
          <div class="mb-5 d-flex justify-content-around">
            <%= will_paginate @annonces, :page_links => true %>
          </div>
          <div
            id="map"
            style="width: 100%;
            height: 600px;"
            data-markers="<%= @markers.to_json %>"
            data-mapbox-api-key="<%= ENV['MAPBOX_API_KEY'] %>"
          ></div>
        </div>
      <% else %>
        <div class="container">
          <h4 class="text-center mt-4 pb-5 mb-5" style="width: 100%; color:#DA334A; font-style: italic;">"Aucune annonce trouvée"</h4>
          <p class="mt-3 mb-4" style="color: rgb(150, 150, 150); width: 100%"><em>Nos annonces disponibles à Paris (<%= @annonces_no_result.count %>)</em></p>
        </div>
        <% @annonces_no_result.each do |annonce| %>
          <div class="col-sm-12 col-md-6 col-lg-4">
            <div class="content border mb-5", style="box-shadow: 0 0 5px rgba(0,0,0,0.1); background-color: white">
              <%= cl_image_tag annonce.photo, class: "rounded-top", style: "height:200px; object-position: center center; object-fit: cover; width: 100%"%>
              <div class="px-3">
                <div class="mt-2">
                  <p class=""class="text-left mb-2", style="font-size: 14px"><i class="fas fa-map-marker-alt"></i> <%= annonce.ville %></p>
                  <p class="text-left text-truncate mt-0", style="font-size: 20px"><%= annonce.titre_annonce %></p>
                </div>
                <div class="mt-0">
                  <p class='my-1', style="font-size: 14px">Nb de pièces: <%= annonce.pièces %></p>
                  <p style="font-size: 14px">Loyer mensuel: <%= annonce.loyer_mensuel %> €</p>
                  <div class="d-flex px-0 justify-content-around">
                    <!-- if agent is assigned to the flat show agent info -->
                    <% unless annonce.agent_user_id.nil? %>
                      <p style="color:rgba(0,0,0,0.6)"><i class="fas fa-phone"></i> <%= User.find(annonce.agent_user_id).téléphone%></p>
                    <% else %>
                      <p style="color:rgba(0,0,0,0.6)"><i class="fas fa-phone"></i> <%= annonce.téléphone%></p>
                    <% end %>
                    <%= link_to "Details", annonce_path(annonce), class: "my-0", style:"font-size: 14px; text-decoration: underline" %>
                    <div class="">
                      <%= link_to "", new_conversation_path(message: {to: annonce.user.id }), class: "fas fa-envelope", style:"font-size: 20px; color: #D8A727" %>
                    </div>
                  </div>
                </div>
              </div>
              <!-- all links with gérer et valider -->
              <% if user_signed_in?  %>
                <!-- if no agent is managing the flat -->
                <% if annonce.agent_user_id.nil? && current_user.statut == "Agent" && annonce.user != current_user %>
                  <!-- Check if agent already applied -->
                  <% if annonce.candidatures.any? { |c| c.user_id = current_user.id} %>
                    <p class="mt-2 pb-0 text-center"><%= link_to "Déja postulé", candidature_agent_path, style:"font-weight: bold; color: green"  %></p>
                    <!--  <p class="mt-2 pb-0 text-center" style="font-weight: bold; color: green">Déja postulé</p> -->
                  <% else %>
                    <div class="text-center my-2" >
                      <%= link_to "Gérer ce bien", new_annonce_candidature_path(annonce), class: "btn btn-transparent", style:"font-size: 14px" %>
                    </div>
                  <% end %>
                  <!-- if agent assigned and the agent is the current user -->
                <% elsif annonce.agent_user_id != nil && annonce.agent_user_id == current_user.id.to_s %>
                  <!-- when flat is rented need to checkout -->
                  <% if annonce.checkout_agent != "check" %>
                    <div class="text-center my-2 " style="">
                      <!-- <p style="font-weight: bold; color: #D8A727">Valider lorsque ce bien est loué</p> -->
                      <%= link_to "Vous avez loué ce bien!", checkout_agent_path(annonce), class: "btn btn-transparent-bold", style:"font-size: 14px",data: { confirm: 'Vous confirmer que ce bien a été loué.' } %>
                    </div>
                  <% else %>
                    <!-- flat is rented and checked out by proprio -->
                    <div class="text-center mt-2" style="font-size: 12px; font-weight: bold">
                      Validation agent
                      <% if annonce.checkout_agent == "check" %>
                        <i class="fas fa-check" style="color: green"></i>
                      <% else %>
                        <i class="fas fa-times" style="color: red"></i>
                      <% end %>
                    </div>
                    <div class="text-center mb-2" style="font-size: 12px; font-weight: bold">
                      Validation propriétaire
                      <% if annonce.checkout_proprio == "check" %>
                        <i class="fas fa-check" style="color: green"></i>
                      <% else %>
                        <i class="fas fa-times" style="color: red"></i>
                      <% end %>
                    </div>
                  <% end %>
                  <!-- agent is assigned and the flat owner is the current user -->
                <% elsif annonce.agent_user_id != nil && annonce.user_id == current_user.id %>
                  <!-- when flat is rented need to checkout -->
                  <% if annonce.checkout_proprio != "check" %>
                    <div class="text-center my-2" style="">
                      <%= form_tag orders_path do %>
                        <%= hidden_field_tag 'annonce_id', annonce.id %>
                        <%= submit_tag 'J\'ai loué mon bien!', data: { confirm: 'Vous confirmez que votre bien a été loué. Vous allez être redirigé vers le site de paiement sécurisé.' }, class: 'btn btn-transparent-bold', style:'font-size: 14px' %>
                      <% end %>
                    </div>
                  <% else %>
                    <!-- flat is rented and checked out by proprio -->
                    <div class="text-center mt-2" style="font-size: 12px; font-weight: bold">
                      Validation agent
                      <% if annonce.checkout_agent == "check" %>
                        <i class="fas fa-check" style="color: green"></i>
                      <% else %>
                        <i class="fas fa-times" style="color: red"></i>
                      <% end %>
                    </div>
                    <div class="text-center mb-2" style="font-size: 12px; font-weight: bold">
                      Validation propriétaire
                      <% if annonce.checkout_proprio == "check" %>
                        <i class="fas fa-check" style="color: green"></i>
                      <% else %>
                        <i class="fas fa-times" style="color: red"></i>
                      <% end %>
                    </div>
                  <% end %>
                <% else %>
                  <p class="" style="color: white; font-size: 21px">hello</p>
                <% end %>
              <% end %>
            </div>
          </div>
        <% end %>
        <!-- Mapbox -->
        <div class="container">
          <div class="mb-5 d-flex justify-content-around">
            <%= will_paginate @annonces_no_result, :page_links => true %>
          </div>
          <div
            id="map"
            style="width: 100%;
            height: 600px;"
            data-markers="<%= @markers.to_json %>"
            data-mapbox-api-key="<%= ENV['MAPBOX_API_KEY'] %>"
          ></div>
        </div>
      <% end %>
    </div>
  <% end %>
</div>
<style>
  .previous_page{
    margin-right: 5px;
  }
  .current {
    margin-right: 5px;
  }
   .next {
    margin-right: 5px;
  }
   .next_page {
    margin-left: 5px;
  }
</style>